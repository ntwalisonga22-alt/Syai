<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SY AI PRO</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0a; --side: #111; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 260px; background: var(--side); border-right: 1px solid #222; display: flex; flex-direction: column; padding: 15px; }
        #main-view { flex: 1; display: flex; flex-direction: column; background: #050505; }
        header { padding: 15px 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: var(--side); }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .msg { max-width: 80%; padding: 15px; border-radius: 12px; font-size: 15px; position: relative; }
        .user { background: #222; align-self: flex-end; border: 1px solid #333; }
        .ai { background: #fff; color: #000; align-self: flex-start; border-left: 4px solid var(--primary); }

        .gen-image { width: 100%; border-radius: 8px; margin-top: 10px; display: block; }
        .download-btn { background: var(--primary); color: #000; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; margin-top: 5px; font-weight: bold; }

        #login-modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        .login-content { background: #1a1a1a; margin: 15% auto; padding: 40px; border: 1px solid var(--primary); width: 320px; border-radius: 20px; text-align: center; }
        
        .input-area { padding: 20px; border-top: 1px solid #222; display: flex; gap: 12px; background: var(--side); }
        input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 10px; outline: none; }
        button { background: var(--primary); color: #000; border: none; padding: 0 25px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-modal">
    <div class="login-content">
        <h2 style="color:var(--primary)">SY AI Access</h2>
        <p style="color:#888; font-size:14px;">Guest limit reached. Log in to continue or keep searching as guest.</p>
        <div id="g_id_onload" data-client_id="YOUR_GOOGLE_CLIENT_ID" data-callback="handleLogin"></div>
        <div class="g_id_signin" data-type="standard"></div>
        <button onclick="closeLogin()" style="background:transparent; color:#555; margin-top:15px; border:none; text-decoration:underline;">Stay as Guest</button>
    </div>
</div>

<div id="sidebar">
    <div style="font-weight:bold; color:var(--primary); margin-bottom:20px;">SY AI HISTORY</div>
    <div id="history-list"></div>
    <div id="user-status" style="margin-top:auto; font-size:12px; color:#666;">Guest Mode</div>
</div>

<div id="main-view">
    <header>
        <span style="color:var(--primary); font-weight:900;">SY AI PRO</span>
        <div onclick="toggleSettings()" style="cursor:pointer">⚙️</div>
    </header>
    <div id="chat-window"></div>
    <div class="input-area">
        <input type="text" id="user-input" placeholder="Ask anything or 'Draw a...'" onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">SEND</button>
    </div>
</div>

<script>
    let searchCount = parseInt(localStorage.getItem('sy_count') || '0');
    let user = JSON.parse(localStorage.getItem('sy_user') || 'null');
    let history = [];

    function handleLogin(response) {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        user = { name: payload.name };
        localStorage.setItem('sy_user', JSON.stringify(user));
        document.getElementById('user-status').innerText = `User: ${user.name}`;
        closeLogin();
    }

    function closeLogin() { document.getElementById('login-modal').style.display = 'none'; searchCount = 0; }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        if (!user && searchCount >= 2) {
            document.getElementById('login-modal').style.display = 'block';
            return;
        }

        const win = document.getElementById('chat-window');
        win.innerHTML += `<div class="msg user">${text}</div>`;
        input.value = '';

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: text, history: history, user: user })
            });
            const data = await res.json();
            
            let html = `<div class="msg ai">${data.reply}`;
            if (data.image) {
                html += `<img src="${data.image}" class="gen-image">
                         <button class="download-btn" onclick="downloadImg('${data.image}')">Download Image</button>`;
            }
            html += `</div>`;
            
            win.innerHTML += html;
            win.scrollTop = win.scrollHeight;

            if(!user) { searchCount++; localStorage.setItem('sy_count', searchCount); }
            history.push({role:"user", parts:[{text:text}]}, {role:"model", parts:[{text:data.reply || "Image generated."}]});
        } catch (e) { console.error(e); }
    }

    function downloadImg(base64) {
        const link = document.createElement('a');
        link.href = base64;
        link.download = `SYAI_${Date.now()}.png`;
        link.click();
    }
</script>
</body>
</html>

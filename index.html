<script>
    let allChats = JSON.parse(localStorage.getItem('sy_all_chats') || '[]');
    let currentChatId = null;
    let currentHistory = [];

    // --- 1. NEW CHAT (FIXED) ---
    function createNewChat() {
        currentChatId = Date.now().toString();
        currentHistory = [];
        document.getElementById('chat-window').innerHTML = `<div class="msg ai">Session Started. I am SY AI. How can I help?</div>`;
        document.getElementById('current-chat-title').innerText = "New Conversation";
        renderHistoryList();
    }

    // --- 2. DELETE CHAT (NEW FEATURE) ---
    function deleteChat(id, event) {
        event.stopPropagation(); // Prevents loading the chat while deleting
        allChats = allChats.filter(c => c.id !== id);
        localStorage.setItem('sy_all_chats', JSON.stringify(allChats));
        if (currentChatId === id) createNewChat();
        renderHistoryList();
    }

    // --- 3. RENDER SIDEBAR (WITH DELETE BTN) ---
    function renderHistoryList() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        allChats.slice().reverse().forEach(chat => {
            const item = document.createElement('div');
            item.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            item.onclick = () => loadChat(chat.id);
            
            item.innerHTML = `
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${chat.title}</span>
                <span onclick="deleteChat('${chat.id}', event)" style="color:red; margin-left:10px; font-weight:bold;">Ã—</span>
            `;
            list.appendChild(item);
        });
    }

    // --- 4. SEND MESSAGE (FIXED AUTO-START) ---
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        // FIX: If no chat is active, start one automatically so answering doesn't stop
        if (!currentChatId) {
            currentChatId = Date.now().toString();
            document.getElementById('chat-window').innerHTML = '';
        }

        const win = document.getElementById('chat-window');
        win.innerHTML += `<div class="msg user">${text}</div>`;
        input.value = '';
        win.scrollTop = win.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text, 
                    history: currentHistory,
                    model: document.getElementById('model-select')?.value || "gemini-3-flash"
                })
            });

            const data = await res.json();
            
            if (data.reply) {
                win.innerHTML += `<div class="msg ai">${data.reply}</div>`;
                
                // Update Memory
                currentHistory.push({ role: "user", parts: [{ text: text }] });
                currentHistory.push({ role: "model", parts: [{ text: data.reply }] });

                // Save to LocalStorage
                saveToLocalStorage(text);
            } else {
                win.innerHTML += `<div class="msg ai" style="color:orange">SY AI: I received an empty response. Check your API Key.</div>`;
            }
            
            win.scrollTop = win.scrollHeight;

        } catch (e) {
            win.innerHTML += `<div class="msg ai" style="color:red">SY AI: Server Connection Failed.</div>`;
        }
    }

    function saveToLocalStorage(firstText) {
        const index = allChats.findIndex(c => c.id === currentChatId);
        if (index > -1) {
            allChats[index].messages = currentHistory;
        } else {
            const title = firstText.split(' ').slice(0, 4).join(' ') || "Chat";
            allChats.push({ id: currentChatId, title: title, messages: currentHistory });
        }
        localStorage.setItem('sy_all_chats', JSON.stringify(allChats));
        renderHistoryList();
    }

    // Load history on startup
    renderHistoryList();
</script>
